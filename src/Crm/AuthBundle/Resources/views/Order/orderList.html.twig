{% extends 'CrmAuthBundle::layout.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/paneloperator/js/bootbox.min.js') }}"></script>
    <script>
        $(document).ready(function(){
            $('.setCard').click(function () {
                var url = $(this).attr('data-href');
                BootstrapDialog.show({
                    title: 'Получение карты',
                    size: BootstrapDialog.SIZE_SMALL,
                    type: BootstrapDialog.TYPE_DANGER,
                    message: 'Вы точно получили карту?',
                    buttons: [{
                        label: 'Да',
                        cssClass: 'btn-danger',
                        autospin: true,
                        action: function (dialogRef) {
                            window.location.href = url;
                        }
                    }, {
                        label: 'Отмена',
                        action: function (dialogRef) {
                            dialogRef.close();
                        }
                    }]
                });
            });
        });

    </script>
{% endblock %}

{% block body %}
    <div>
        <h2>Карты водителей ({{ orders | length }} шт)</h2>
        <div class="dropdown" style="float: right; margin-top: -55px">
            <button class="btn btn-primary dropdown-toggle" type="button" id="addOrder" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                Добавить новый заказ
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="addOrder">
                <li><a href="{{ path('auth_add_skzi') }}">СКЗИ</a></li>
                <li><a href="{{ path('auth_add_estr') }}">ЕСТР</a></li>
                {% if app.user.company.operator.id is defined and app.user.company.operator.id == 33 %}
                {% else %}
                    <li><a href="{{ path('auth_add_ru') }}">РФ</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
    <form method="GET">
        <div class="row">
            <div class="col-xs-4">
                <select class="form-control" name="type">
                    <option selected="selected" value="0">Все типы</option>
                    <option value="skzi">СКЗИ</option>
                    <option value="estr">ЕСТР</option>
                    <option value="ru">РФ</option>
                </select>
            </div>
            <div class="col-xs-6">
                <input placeholder="Введите слово" class="form-control" style="margin-top: 0;" name="search">
            </div>
            <div class="col-xs-2">
                <button type="submit" class="btn btn-primary">Найти</button>
            </div>
        </div>
    </form>
    <div class="row">
        <table class="table">
            <tr>
                <td>Номер</td>
                <td>Дата заявки</td>
                <td>Ф.И.О.</td>
                <td>Тип заявки</td>
                <td>Статус</td>
                <td>Цена</td>
                <td>Коммент</td>
                <td></td>
            </tr>
            {% for o in orders %}
                {% if o.enabled == 1 %}
                    <tr class="{{ o.comment != null and o.comment != '' ? 'warning' : ''}}">
                        <td>
                            {#{% if o.estr == 0 and o.ru == 0 %}#}
                            {#<a href="{{ path('auth_user_skzi_edit', {'userId' : o.id}) }}">{{ o.id }}</a>#}
                            {#{% else %}#}
                            <a href="{{ path('auth_user_edit', {'userId' : o.id}) }}">{{ o.id }}</a>
                            {#{% endif %}#}
                        </td>
                        <td>{{ o.created | date('d.m.Y') }}</td>
                        <td>{{ o }}</td>
                        <td>{{ o.ru ? 'РФ' : o.estr ? 'ЕСТР' : 'СКЗИ'  }}</td>
                        <td>
                            <div class="statusBox">
                                {{ o.statusStringTwig | raw }}
                                <div class="statusItems">
                                    {% for status in o.statusArray %}
                                        {{ status.title | raw }}&nbsp;-&nbsp;{{ status.date | date('d.m.Y') }}<br />
                                    {% endfor %}
                                </div>
                            </div>
                        </td>
                        <td>{{ o.price }}</td>
                        <td>{{ o.comment }}</td>
                        <td>
                            {% if o.status == 0 %}
                                <div class="dropdown">
                                    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownPayment" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Оплата
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownPayment}">
                                        {% if o.company != null and not ( o.company.operator.id is defined and o.company.operator.id == 39 ) %}
                                            <li><a href="{{ path('generate_payment_pdf') }}?ord={{ o.id }}" target="_blank">Платежное поручение</a></li>
                                            <li><a href="{{ path('payment_assist',{'userId' : o.id} )  }}" target="_blank">Робокасса</a></li>
                                        {% endif %}
                                        <li><a href="https://im-kard.ru{{ path('generate_pdf_statement',{'id' : o.id}) }}" target="_blank">Скачать заявку</a></li>
                                    </ul>
                                </div>
                            {% endif %}
                            {% if o.status == 4 %}
                                <a data-href="{{ path('auth_status_set', { 'id' : o.id }) }}" class="setCard"><button class="btn btn-primary">Получено</button></a>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
            {% else %}
                <tr>
                    <td colspan="7" style="text-align: center" class="text-danger">Заказов карт не найдено</td>
                </tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .statusItems{
            display: none;
        }
        .statusBox{
            font-size: 12px;
            cursor: pointer;
            margin-top: 6px;
        }
        .statusBox:hover .statusItems{
            display: block;
            position: absolute;
            background: #FFFFFF;
            border: 1px solid #C2C2C2;
            padding: 5px;
        }
    </style>
{% endblock %}